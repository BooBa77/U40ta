# Модуль Home - Главная страница приложения

## Обзор

Модуль `Home` представляет собой главную страницу приложения U40TA, содержащую основной функционал для работы с ведомостями, почтовыми вложениями и управлением режимом работы. Модуль также обеспечивает обработку глубоких ссылок через QR-коды для быстрого доступа к карточкам объектов.

## Структура компонентов

### Основные компоненты

1. **Home.vue** - Корневой компонент главной страницы
2. **EmailAttachmentsSection.vue** - Секция управления почтовыми вложениями
3. **FlightModeToggle.vue** - Переключатель режима полёта (офлайн/онлайн)
4. **FlightModeOverlay.vue** - Визуальный оверлей режима полёта

### Вспомогательные компоненты (из shared/ui)

- ExitButton.vue - Кнопка выхода из системы
- PWAInstallButton.vue - Кнопка установки PWA
- QrScannerButton.vue - Кнопка сканирования QR-кодов
- DBToolsButton.vue - Кнопка инструментов БД

## Функциональность

### 1. Управление почтовыми вложениями

**EmailAttachmentsSection.vue** обеспечивает:

- Отображение списка вложений из email
- Фильтрацию по правам доступа (через таблицу `mol_access`)
- Возможность открытия ведомостей
- Удаление вложений (только в онлайн-режиме)
- Ручную проверку почты
- Реальную синхронизацию через Server-Sent Events (SSE)

**Особенности:**

- Доступ к вложениям определяется через таблицу `mol_access`
- Удаление недоступно в режиме полёта
- Автоматическое обновление при изменениях через SSE

### 2. Режим полёта (Flight Mode)

**FlightModeToggle.vue** - центральный элемент управления офлайн-режимом:

**Функции:**

- Включение/выключение офлайн-режима
- Автоматическое кэширование данных при включении
- Проверка изменений при выключении
- Визуальная индикация состояния

**Визуальные особенности (в режиме полёта):**

- Увеличенная на 40% кнопка по сравнению с онлайн-режимом
- Анимация покачивания самолёта

**Интеграция:**

- Событие `flight-mode-changed` для синхронизации между компонентами
- Использование `localStorage` для сохранения состояния

### 3. Обработка глубоких ссылок (QR-коды)

**Home.vue** поддерживает обработку QR-ссылок в формате `https://u40ta.booba.fvds.ru/scan/{qrCode}`:

**Рабочий процесс:**

1. Пользователь сканирует/переходит по QR-ссылке
2. Система проверяет авторизацию через Vue Router guard
3. Неавторизованные пользователи перенаправляются на Login с сохранением полного URL
4. После авторизации автоматический переход на Home с параметром `qr={полный_URL}`
5. Home автоматически вызывает `handleQrScan()` с QR-значением
6. Открывается модальное окно `ObjectFormModal` с данными объекта

**Особенности:**

- Полный URL ссылки хранится как `qr_value` в БД
- Поддержка как онлайн, так и офлайн режимов через `QrService`
- Автоматическая очистка query-параметров после обработки
- Единая логика для сканирования камерой и перехода по ссылке

## Интеграция с другими модулями

### 1. Модуль Statements

- Переход на страницу ведомости через `router.push(/statement/${attachmentId})`
- Получение SSE событий об удалении ведомостей

### 2. Модуль Inventory (в разработке)

- Переход на страницу инвентаризации для соответствующих файлов

### 3. Модуль Router

- Обработка маршрута `/scan/:qrCode` через глобальный guard
- Сохранение redirect-параметров для неавторизованных пользователей
- Интеграция с Login.vue для восстановления пути после авторизации

### 4. Backend API

- **GET /api/email/attachments** - получение списка вложений
- **DELETE /api/email/attachments/:id** - удаление вложения
- **POST /api/email/check-now** - ручная проверка почты
- **GET /api/app-events/sse** - SSE подключение
- **GET /api/qr-codes/scan** - поиск объекта по QR-коду
- **GET /api/objects/{id}** - получение данных объекта

## Логика доступа

### Фильтрация вложений

1. **Backend фильтрация:** Контроллер `EmailController.getAllAttachments()`
2. **Основа:** Таблица `mol_access` (user_id, zavod, sklad)
3. **Правило:** Пользователь видит только вложения для своих складов

### Управление правами

- Добавление/удаление доступов через админку
- Нет разделения по ролям на главной странице
- Админ = обычный пользователь с назначенными складами

## Особенности реализации

### Server-Sent Events (SSE)

- Реальная синхронизация между вкладками
- События:
  - `email-attachments-updated` - обновление списка
  - `email-attachment-deleted` - удаление вложения
- Автоматическое переподключение при разрыве

### Офлайн-режим

- Кэширование данных в IndexedDB
- Блокировка функций:
  - Удаление вложений
  - Проверка почты
  - Установка PWA
- Визуальные индикаторы состояния

### Обработка QR-ссылок

- Маршрутизация через Vue Router с guard'ами
- Сохранение полного URL как qr_value в БД
- Единый интерфейс `QrService` для онлайн/офлайн поиска
- Автоматическая очистка URL после обработки

### Производительность

- Ленивая загрузка компонентов
- Оптимизированные запросы к API
- Локальное обновление UI при изменениях
- Минимальное количество перерисовок

## Стили и UI/UX

### Дизайн-токены

Используются CSS переменные:

```css
--spacing, --spacing-lg, --spacing-sm
--border-color, --border-width, --border-radius-lg
--shadow, --shadow-lg
--transition

## Меры безопасности
- JWT авторизация для всех API-запросов
- Фильтрация SQL-запросов через параметризованные запросы
- Валидация ID при удалении вложений
- Защита от XSS через Vue.js санитизацию